<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="Jeedom Home Control">
    <meta name="author" content="MULLER Franck">
    <title>Home Control</title>

    <!-- GOOGLE WEB FONT -->
    <link href="https://fonts.googleapis.com/css?family=Work+Sans:400,500,600" rel="stylesheet">
    <!-- BASE CSS -->
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/menu.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
    <link href="css/vendors.css" rel="stylesheet">
    <!-- YOUR CUSTOM CSS -->
    <link href="css/custom.css" rel="stylesheet">
</head>
<body>

<div id="preloader">
    <div data-loader="circle-side"></div>
</div><!-- /Preload -->

<div id="loader_form">
    <div data-loader="circle-side-2"></div>
</div><!-- /loader_form -->

<div class="container-fluid full-height">
    <div class="row row-height">
        <div class="col-lg-6 content-left">
            <div class="content-left-wrapper">
                <a href="index.html" id="logo" class="dtime"></a>
                <div id="social">
                    <ul>
                        <li><a href="#" id="open_bnb" class="btn btn-primary">+</a></li>
                    </ul>
                </div>
                <div>
                    <figure><img src="img/info_graphic_1.svg" alt="" class="img-fluid"></figure>
                    <h2 class="bloc_left_name"></h2>
                    <div class="col-lg-6 float-left add_modules_l_left"></div>
                    <div class="col-lg-6 float-right add_modules_l_right"></div>
                </div>
                <div class="copy"></div>
            </div>
            <!-- /content-left-wrapper -->
        </div>
        <!-- /content-left -->
        <div class="col-lg-6 content-right" id="start" style="padding: 60px 90px 35px 90px;text-align: center;">
            <div id="wizard_container">
                <div id="middle-wizard">
                    <div class="step">
                        <div id="panel_ext">
                            <figure><img src="img/info_graphic_2.svg" alt="" class="img-fluid"></figure>
                            <h2 class="bloc_right_name"></h2>
                            <div class="col-lg-6 float-left add_modules_r_left"></div>
                            <div class="col-lg-6 float-right add_modules_r_right"></div>
                        </div>
                        <!-- /row -->
                    </div>
                    <!-- /step-->
                    <div class="step">
                        <div id="panel_bnb">
                            <figure><img src="img/info_graphic_3.svg" alt="" class="img-fluid"></figure>
                            <h2 class="bloc_cached_name"></h2>
                            <div class="col-lg-6 float-left add_modules_c_left"></div>
                            <div class="col-lg-6 float-right add_modules_c_right"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- COMMON SCRIPTS -->

<script src="js/jquery-3.2.1.min.js"></script>
<script src="js/moment-with-locales.js"></script>
<script src="js/velocity.min.js"></script>
<script src="js/functions.js"></script>

<script>
    $(document).ready(function() {
        //date-time
        date_time();
        setInterval(date_time, 1000);
        //start call for create and update blocks
        $.ajax({
            url: "data/data.json?v=0.1.81",
            type: "GET",
            dataType: "json",
            success: function (e) {
                let append = '';
                var r = e.bloc_right.panel_left;
                var d = e.bloc_right.panel_right;
                var b = e.bloc_left.panel_left;
                var c = e.bloc_left.panel_right;
                var f = e.bloc_cached.panel_left;
                var g = e.bloc_cached.panel_right;
                //store global conf
                localStorage.setItem('Jeedom_url', e.global.jeedom_ip);
                localStorage.setItem('Jeedom_API', e.global.jeedom_apikey);
                //naming blocks
                $(".bloc_left_name").text(e.bloc_left.name);
                $(".bloc_right_name").text(e.bloc_right.name);
                $(".bloc_cached_name").text(e.bloc_cached.name);

                //right block
                $.each(r, function(key,value) {

                    append = '<a href="#" id="'+value.id+'" cmd-id-tog="'+value.cmd_id_tog+'" cmd-id-on="'+value.cmd_id_on+'" cmd-id-off="'+value.cmd_id_off+'" cmd-id="'+value.cmd_id+'" refresh-id="'+value.refresh_id+'" >\n' +
                        '                            <div class="card text-white bg-primary mb-3" style="max-width: 18rem;">\n' +
                        '                                <div class="card-body">\n' +
                        '                                    <h5 class="card-title">'+value.name+'</h5>\n' +
                        '                                    <p class="card-text text-white">N/A</p>\n' +
                        '                                </div>\n' +
                        '                            </div>\n' +
                        '                        </a>';
                    $(".add_modules_r_left").append(append);

                    let n = value.id.startsWith("swt");
                    let nn = value.id.startsWith("temp");
                    if (n === true){
                        switch_state(value.refresh_id, value.cmd_id_tog, value.cmd_id_on, value.cmd_id_off, value.id);
                    }
                    if (nn === true){
                        temp_state(value.refresh_id, value.id);
                    }

                });
                $.each(d, function(key,value) {
                    append = '<a href="#" id="'+value.id+'" cmd-id-tog="'+value.cmd_id_tog+'" cmd-id-on="'+value.cmd_id_on+'" cmd-id-off="'+value.cmd_id_off+'" cmd-id="'+value.cmd_id+'" refresh-id="'+value.refresh_id+'" >\n' +
                        '                            <div class="card text-white bg-primary mb-3" style="max-width: 18rem;">\n' +
                        '                                <div class="card-body">\n' +
                        '                                    <h5 class="card-title">'+value.name+'</h5>\n' +
                        '                                    <p class="card-text text-white">N/A</p>\n' +
                        '                                </div>\n' +
                        '                            </div>\n' +
                        '                        </a>';
                    $(".add_modules_r_right").append(append);
                    let n = value.id.startsWith("swt");
                    let nn = value.id.startsWith("temp");
                    if (n === true){
                        switch_state(value.refresh_id, value.cmd_id_tog, value.cmd_id_on, value.cmd_id_off, value.id);
                    }
                    if (nn === true){
                        temp_state(value.refresh_id, value.id);
                    }
                });

                //left block
                $.each(b, function(key,value) {
                    var append_temp = '';
                    if (value.temp === "1"){
                        append_temp = '<small><span aria-hidden="true" temp-cmd-id="'+value.temp_refresh_id+'" id="'+value.temp_id+'"></span>°c / <span aria-hidden="true" hum-cmd-id="'+value.hum_refresh_id+'" id="'+value.hum_id+'"></span>%</small>';
                    }
                    append = '<a href="#" id="'+value.id+'" cmd-id-tog="'+value.cmd_id_tog+'" cmd-id-on="'+value.cmd_id_on+'" cmd-id-off="'+value.cmd_id_off+'" cmd-id="'+value.cmd_id+'" refresh-id="'+value.refresh_id+'" >\n' +
                        '                            <div class="card text-white bg-primary mb-3" style="max-width: 18rem;">\n' +
                        '                                <div class="card-body">\n' +
                        '                                    <h5 class="card-title">'+value.name+'</h5>\n' +
                        '                                    <p class="card-text text-white">N/A</p>\n' + append_temp +
                        '                                </div>\n' +
                        '                            </div>\n' +
                        '                        </a>';
                    $(".add_modules_l_left").append(append);
                    let n = value.id.startsWith("swt");
                    if (n === true){
                        switch_state(value.refresh_id, value.cmd_id_tog, value.cmd_id_on, value.cmd_id_off, value.id);
                    }
                    if (value.temp === "1"){
                        temp_state(value.temp_refresh_id, value.temp_id);
                        temp_state(value.hum_refresh_id, value.hum_id);
                    }
                });
                $.each(c, function(key,value) {
                    var append_temp = '';
                    if (value.temp === "1"){
                        append_temp = '<small><span aria-hidden="true" temp-cmd-id="'+value.temp_refresh_id+'" id="'+value.temp_id+'"></span>°c / <span aria-hidden="true" hum-cmd-id="'+value.hum_refresh_id+'" id="'+value.hum_id+'"></span>%</small>';
                    }
                    append = '<a href="#" id="'+value.id+'" cmd-id-tog="'+value.cmd_id_tog+'" cmd-id-on="'+value.cmd_id_on+'" cmd-id-off="'+value.cmd_id_off+'" cmd-id="'+value.cmd_id+'" refresh-id="'+value.refresh_id+'" >\n' +
                        '                            <div class="card text-white bg-primary mb-3" style="max-width: 18rem;">\n' +
                        '                                <div class="card-body">\n' +
                        '                                    <h5 class="card-title">'+value.name+'</h5>\n' +
                        '                                    <p class="card-text text-white">N/A</p>\n' + append_temp +
                        '                                </div>\n' +
                        '                            </div>\n' +
                        '                        </a>';
                    $(".add_modules_l_right").append(append);
                    let n = value.id.startsWith("swt");
                    if (n === true){
                        switch_state(value.refresh_id, value.cmd_id_tog, value.cmd_id_on, value.cmd_id_off, value.id);
                    }
                    if (value.temp === "1"){
                        temp_state(value.temp_refresh_id, value.temp_id);
                        temp_state(value.hum_refresh_id, value.hum_id);
                    }
                });

                //cached block
                $.each(f, function(key,value) {
                    var append_temp = '';
                    if (value.temp === "1"){
                        append_temp = '<small><span aria-hidden="true" temp-cmd-id="'+value.temp_refresh_id+'" id="'+value.temp_id+'"></span>°c / <span aria-hidden="true" hum-cmd-id="'+value.hum_refresh_id+'" id="'+value.hum_id+'"></span>%</small>';
                    }
                    append = '<a href="#" id="'+value.id+'" cmd-id-tog="'+value.cmd_id_tog+'" cmd-id-on="'+value.cmd_id_on+'" cmd-id-off="'+value.cmd_id_off+'" cmd-id="'+value.cmd_id+'" refresh-id="'+value.refresh_id+'" >\n' +
                        '                            <div class="card text-white bg-primary mb-3" style="max-width: 18rem;">\n' +
                        '                                <div class="card-body">\n' +
                        '                                    <h5 class="card-title">'+value.name+'</h5>\n' +
                        '                                    <p class="card-text text-white"></p>\n' + append_temp +
                        '                                </div>\n' +
                        '                            </div>\n' +
                        '                        </a>';
                    $(".add_modules_c_left").append(append);
                    let n = value.id.startsWith("swt");
                    if (n === true){
                        switch_state(value.refresh_id, value.cmd_id_tog, value.cmd_id_on, value.cmd_id_off, value.id);
                    }
                    if (value.temp === "1"){
                        temp_state(value.temp_refresh_id, value.temp_id);
                        temp_state(value.hum_refresh_id, value.hum_id);
                    }
                });
                $.each(g, function(key,value) {
                    var append_temp = '';
                    if (value.temp === "1"){
                        append_temp = '<small><span aria-hidden="true" temp-cmd-id="'+value.temp_refresh_id+'" id="'+value.temp_id+'"></span>°c / <span aria-hidden="true" hum-cmd-id="'+value.hum_refresh_id+'" id="'+value.hum_id+'"></span>%</small>';
                    }
                    append = '<a href="#" id="'+value.id+'" cmd-id-tog="'+value.cmd_id_tog+'" cmd-id-on="'+value.cmd_id_on+'" cmd-id-off="'+value.cmd_id_off+'" cmd-id="'+value.cmd_id+'" refresh-id="'+value.refresh_id+'" >\n' +
                        '                            <div class="card text-white bg-primary mb-3" style="max-width: 18rem;">\n' +
                        '                                <div class="card-body">\n' +
                        '                                    <h5 class="card-title">'+value.name+'</h5>\n' +
                        '                                    <p class="card-text text-white"></p>\n' + append_temp +
                        '                                </div>\n' +
                        '                            </div>\n' +
                        '                        </a>';
                    $(".add_modules_c_right").append(append);
                    let n = value.id.startsWith("swt");
                    if (n === true){
                        switch_state(value.refresh_id, value.cmd_id_tog, value.cmd_id_on, value.cmd_id_off, value.id);
                    }
                    if (value.temp === "1"){
                        temp_state(value.temp_refresh_id, value.temp_id);
                        temp_state(value.hum_refresh_id, value.hum_id);
                    }
                });
            },
            complete: function (e) {

            }
        });
        // update modules
        setInterval(update_page, 60000);
        // cached block
        $("#panel_bnb").hide();
        $("#open_bnb").on('click', function () {
            //$(this).toggleAttribute("text", "-", "+");
            var x = document.getElementById("open_bnb");
            if (x.innerHTML === "+") {
                x.innerHTML = "-";
                $(this).attr("style", "background-color: #d80075!important");

            } else {
                x.innerHTML = "+";
                $(this).attr("style", "background-color: #007bff!important");
            }
            $("#panel_ext").toggle(800);
            $("#panel_bnb").toggle(800);
        });
        // click modules on/off
        $(document).on('click','a[id^="swt_"]', function (e) {
            e.preventDefault();
            let cmd_id = $(this).attr("cmd-id");
            let refresh_id = $(this).attr("refresh-id");
            let swt_id = $(this).attr("id");
            let cmd_id_tog = $(this).attr("cmd-id-tog");
            let cmd_id_on = $(this).attr("cmd-id-on");
            let cmd_id_off = $(this).attr("cmd-id-off");
            $.ajax({
                url: "http://"+localStorage.getItem('Jeedom_url')+"/core/api/jeeApi.php?apikey="+localStorage.getItem('Jeedom_API')+"&type=cmd&id="+cmd_id,
                type: "GET",
                dataType: "json",
                success: function (r) {
                    if (r == 0){
                        setTimeout(function(){switch_state (refresh_id, cmd_id_tog, cmd_id_on, cmd_id_off, swt_id)},700);
                    }
                    else{
                        $("#switch").text("error")
                    }
                }
            })
        })
    });
    function date_time() {
        $(".dtime").text(moment().locale('fr').format('LLLL'));
    }
    //update page modules
    function update_page() {
        $.ajax({
            url: "data/data.json?v=0.1.7",
            type: "GET",
            dataType: "json",
            success: function (e) {
                var r = e.bloc_right.panel_left;
                var d = e.bloc_right.panel_right;
                var b = e.bloc_left.panel_left;
                var c = e.bloc_left.panel_right;
                var f = e.bloc_cached.panel_left;
                var g = e.bloc_cached.panel_right;

                $.each(r, function(key,value) {
                    let n = value.id.startsWith("swt");
                    if (n === true){
                        switch_state(value.refresh_id, value.cmd_id_tog, value.cmd_id_on, value.cmd_id_off, value.id);
                    }
                    if (value.temp === "1"){
                        temp_state(value.temp_refresh_id, value.temp_id);
                        temp_state(value.hum_refresh_id, value.hum_id);
                    }
                });
                $.each(d, function(key,value) {
                    let n = value.id.startsWith("swt");
                    if (n === true){
                        switch_state(value.refresh_id, value.cmd_id_tog, value.cmd_id_on, value.cmd_id_off, value.id);
                    }
                    if (value.temp === "1"){
                        temp_state(value.temp_refresh_id, value.temp_id);
                        temp_state(value.hum_refresh_id, value.hum_id);
                    }
                });
                $.each(b, function(key,value) {
                    let n = value.id.startsWith("swt");
                    if (n === true){
                        switch_state(value.refresh_id, value.cmd_id_tog, value.cmd_id_on, value.cmd_id_off, value.id);
                    }
                    if (value.temp === "1"){
                        temp_state(value.temp_refresh_id, value.temp_id);
                        temp_state(value.hum_refresh_id, value.hum_id);
                    }
                });
                $.each(c, function(key,value) {
                    let n = value.id.startsWith("swt");
                    if (n === true){
                        switch_state(value.refresh_id, value.cmd_id_tog, value.cmd_id_on, value.cmd_id_off, value.id);
                    }
                    if (value.temp === "1"){
                        temp_state(value.temp_refresh_id, value.temp_id);
                        temp_state(value.hum_refresh_id, value.hum_id);
                    }
                });
                $.each(f, function(key,value) {
                    let n = value.id.startsWith("swt");
                    if (n === true){
                        switch_state(value.refresh_id, value.cmd_id_tog, value.cmd_id_on, value.cmd_id_off, value.id);
                    }
                    if (value.temp === "1"){
                        temp_state(value.temp_refresh_id, value.temp_id);
                        temp_state(value.hum_refresh_id, value.hum_id);
                    }
                });
                $.each(g, function(key,value) {
                    let n = value.id.startsWith("swt");
                    if (n === true){
                        switch_state(value.refresh_id, value.cmd_id_tog, value.cmd_id_on, value.cmd_id_off, value.id);
                    }
                    if (value.temp === "1"){
                        temp_state(value.temp_refresh_id, value.temp_id);
                        temp_state(value.hum_refresh_id, value.hum_id);
                    }
                });
            }
        });

        // temp_state(1564, "temp_salon");
        // temp_state(1565, "hum_salon");
        // temp_state(1559, "temp_room");
        // temp_state(1560, "hum_room");
        // temp_state(1573, "temp_bnb_h");
        // temp_state(1582, "temp_bnb_b");
        // temp_state(1574, "hum_bnb_h");
        // temp_state(1583, "hum_bnb_b");
        //
        // switch_state(1383, "swt_cuisine");
        // switch_state(13, "swt_salon");
        // switch_state(1320, "swt_sdb");
        // switch_state(1166, "swt_bnb_cum");
        // switch_state(871, "swt_room")
    }
    //update modules function
    function temp_state(cmd_id, switch_id) {
        $.ajax({
            url: "http://"+localStorage.getItem('Jeedom_url')+"/core/api/jeeApi.php?apikey="+localStorage.getItem('Jeedom_API')+"&type=cmd&id="+cmd_id,
            type: "GET",
            dataType: "json",
            success: function (r) {
                //console.log(r);
                $("#"+switch_id).text(r);
            }
        })
    }
    function switch_state(refresh_id, cmd_id_tog, cmd_id_on, cmd_id_off, switch_id){
        $.ajax({
            url: "http://"+localStorage.getItem('Jeedom_url')+"/core/api/jeeApi.php?apikey="+localStorage.getItem('Jeedom_API')+"&type=cmd&id="+refresh_id,
            type: "GET",
            dataType: "json",
            success: function (r) {
                if (r == 0){
                    $("#"+switch_id+" .card").attr("style", "background-color: #434bdf!important");
                    $("#"+switch_id+" .card-text").text("Éteind");
                    if (cmd_id_tog === "0"){
                        $("#"+switch_id).attr("cmd-id", cmd_id_on)
                    }
                }
                if (r == 1){
                    $("#"+switch_id+" .card").attr("style", "background-color: #d80075!important");
                    $("#"+switch_id+" .card-text").text("Allumé");
                    if (cmd_id_tog === "0"){
                        $("#"+switch_id).attr("cmd-id", cmd_id_off);
                    }
                }
            }
        })
    }
</script>
</body>
</html>